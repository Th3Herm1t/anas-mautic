version: '3.9'

services:
  mautic:
    # Build from local Dockerfile
    build: .
    restart: always
    environment:
      - MAUTIC_DB_HOST=db
      - MAUTIC_DB_PORT=3306
      - MAUTIC_DB_USER=mautic
      - MAUTIC_DB_PASSWORD=${DB_PASSWORD:-mautic}
      - MAUTIC_DB_NAME=mautic
      - MAUTIC_DB_DATABASE=mautic
      - MAUTIC_RUN_CRON_JOBS=true
      - MAUTIC_TRUSTED_PROXIES=["0.0.0.0/0"]
    volumes:
      # NEW STRATEGY: Only persist specific directories, not entire app
      # This allows code updates from new images to take effect
      - mautic_config:/var/www/html/docroot/config # DB credentials, settings
      - mautic_var:/var/www/html/var # Cache, logs, sessions
      - mautic_media:/var/www/html/docroot/media # Uploaded assets
      # NOTE: plugins/ and themes/ are synced from image by entrypoint
    expose:
      - "80"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  db:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=mautic
      - MYSQL_USER=mautic
      - MYSQL_PASSWORD=${DB_PASSWORD:-mautic}
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mautic_config:
  mautic_var:
  mautic_media:
  db_data:


